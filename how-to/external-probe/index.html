<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>External Probe - Cloudprober</title>
    <meta name="generator" content="Hugo 0.54.0" />

    
    <link rel="canonical" href="https://katee.github.io/cloudprober/how-to/external-probe/">
    

    <meta property="og:url" content="https://katee.github.io/cloudprober/how-to/external-probe/">
    <meta property="og:title" content="Cloudprober">
    
    <meta name="apple-mobile-web-app-title" content="Cloudprober">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://katee.github.io/cloudprober/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://katee.github.io/cloudprober/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://katee.github.io/cloudprober/fonts/icon.eot');
        src: url('https://katee.github.io/cloudprober/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://katee.github.io/cloudprober/fonts/icon.woff')
               format('woff'),
             url('https://katee.github.io/cloudprober/fonts/icon.ttf')
               format('truetype'),
             url('https://katee.github.io/cloudprober/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://katee.github.io/cloudprober/stylesheets/application.css">
    <link rel="stylesheet" href="https://katee.github.io/cloudprober/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://katee.github.io/cloudprober/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://katee.github.io/cloudprober/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://katee.github.io/cloudprober/javascripts/modernizr.js"></script>

    

  </head>
  <body class=" ">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        External Probe
      </div>
    </div>

    

    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/Katee/cloudprober" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Cloudprober </strong>
        
          <br>
          Katee/cloudprober
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/Katee/cloudprober/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/Katee/cloudprober/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Overview" href="https://katee.github.io/cloudprober/">
	
	Overview
</a>



  
</li>



<li>
  
    



<a  title="Getting Started" href="https://katee.github.io/cloudprober/getting-started/">
	
	Getting Started
</a>



  
</li>



<li>
  
    



<a  title="What is a Probe" href="https://katee.github.io/cloudprober/concepts/probe/">
	
	What is a Probe
</a>



  
</li>



<li>
  
    <span class="section">How-Tos</span>
    <ul>
      
        
        



<a class="current" title="External Probe" href="https://katee.github.io/cloudprober/how-to/external-probe/">
	
	External Probe
</a>


<ul id="scrollspy">
</ul>


      
        
        



<a  title="Extending Cloudprober" href="https://katee.github.io/cloudprober/how-to/extensions/">
	
	Extending Cloudprober
</a>



      
    </ul>
  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>External Probe </h1>

			

<p>External probe type allows you to run arbitrary, complex probes through
Cloudprober. An external probe runs an independent external program for actual
probing. Cloudprober calculates probe metrics based on program&rsquo;s exit status
and time elapsed in execution. Cloudprober also allows external programs to provide additional metrics over stdout.</p>

<h2 id="sample-probe">Sample Probe</h2>

<p>To understand how it works, lets create a sample probe that sets and gets a key
in a redis server. Here is the <code>main</code> function of such a probe:</p>

<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">client</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">Client</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="p">=</span> <span class="s">&#34;hello&#34;</span>
    <span class="nx">startTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="nx">client</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;world&#34;</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;set_latency_ms %f\n&#34;</span><span class="p">,</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">startTime</span><span class="p">).</span><span class="nf">Nanoseconds</span><span class="p">())</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>

    <span class="nx">startTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="nx">val</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s=%s&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;get_latency_ms %f\n&#34;</span><span class="p">,</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">startTime</span><span class="p">).</span><span class="nf">Nanoseconds</span><span class="p">())</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>(Full listing: <a href="https://github.com/google/cloudprober/blob/master/examples/external/redis_probe.go">https://github.com/google/cloudprober/blob/master/examples/external/redis_probe.go</a>)</p>

<p>This program sets and gets a key in redis and prints the time taken for both operations. Cloudprober can use this program as an external probe, to verify
the availability and performance of the redis server. This program assumes that
redis server is running locally, at its default port. For the sake of demonstration, lets run a local redis server (you can also easily modify this program to use a different server.)</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!bash
</span><span class="cp"></span>brew install redis</code></pre></div>

<p>Let&rsquo;s compile our probe program (redis_probe.go) and verify that it&rsquo;s working
as expected:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!bash
</span><span class="cp"></span>go build ./redis_probe.go
./redis_probe
set_latency_ms <span class="m">22</span>.656588
<span class="m">2018</span>/02/26 <span class="m">15</span>:16:14 <span class="nv">hello</span><span class="o">=</span>world
get_latency_ms <span class="m">2</span>.173560</code></pre></div>

<h2 id="configuration">Configuration</h2>

<p>Here is the external probe configuration that makes use of this program:</p>

<p>Full example in <a href="https://github.com/google/cloudprober/blob/master/examples/external/cloudprober.cfg">examples/external/cloudprober.cfg</a>.</p>

<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="err">#</span> <span class="n">Run</span> <span class="n">an</span> <span class="n">external</span> <span class="n">probe</span> <span class="n">that</span> <span class="n">executes</span> <span class="n">a</span> <span class="n">command</span> <span class="n">from</span> <span class="n">the</span> <span class="n">current</span> <span class="n">working</span><span class="err">
</span><span class="err">#</span> <span class="n">directory.</span><span class="err">
</span><span class="err"></span><span class="n">probe</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="n">name</span><span class="o">:</span> <span class="s">&#34;redis_probe&#34;</span><span class="err">
</span><span class="err"></span>  <span class="n">type</span><span class="o">:</span> <span class="n">EXTERNAL</span><span class="err">
</span><span class="err"></span>  <span class="n">targets</span> <span class="p">{</span> <span class="n">dummy_targets</span> <span class="p">{}</span> <span class="p">}</span><span class="err">
</span><span class="err"></span>  <span class="n">external_probe</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="n">mode</span><span class="o">:</span> <span class="n">ONCE</span><span class="err">
</span><span class="err"></span>    <span class="n">command</span><span class="o">:</span> <span class="s">&#34;./redis_probe&#34;</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div>

<p>Running it through cloudprober, you&rsquo;ll see the following output:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Launch cloudprober</span>
cloudprober --config_file<span class="o">=</span>cloudprober.cfg

cloudprober <span class="m">1519</span>..0 <span class="m">1519583408</span> <span class="nv">labels</span><span class="o">=</span><span class="nv">ptype</span><span class="o">=</span>external,probe<span class="o">=</span>redis_probe,dst<span class="o">=</span> <span class="nv">success</span><span class="o">=</span><span class="m">1</span> <span class="nv">total</span><span class="o">=</span><span class="m">1</span> <span class="nv">latency</span><span class="o">=</span><span class="m">12143</span>.765
cloudprober <span class="m">1519</span>..1 <span class="m">1519583408</span> <span class="nv">labels</span><span class="o">=</span><span class="nv">ptype</span><span class="o">=</span>external,probe<span class="o">=</span>redis_probe,dst<span class="o">=</span> <span class="nv">set_latency_ms</span><span class="o">=</span><span class="m">0</span>.516 <span class="nv">get_latency_ms</span><span class="o">=</span><span class="m">0</span>.491
cloudprober <span class="m">1519</span>..2 <span class="m">1519583410</span> <span class="nv">labels</span><span class="o">=</span><span class="nv">ptype</span><span class="o">=</span>external,probe<span class="o">=</span>redis_probe,dst<span class="o">=</span> <span class="nv">success</span><span class="o">=</span><span class="m">2</span> <span class="nv">total</span><span class="o">=</span><span class="m">2</span> <span class="nv">latency</span><span class="o">=</span><span class="m">30585</span>.915
cloudprober <span class="m">1519</span>..3 <span class="m">1519583410</span> <span class="nv">labels</span><span class="o">=</span><span class="nv">ptype</span><span class="o">=</span>external,probe<span class="o">=</span>redis_probe,dst<span class="o">=</span> <span class="nv">set_latency_ms</span><span class="o">=</span><span class="m">0</span>.636 <span class="nv">get_latency_ms</span><span class="o">=</span><span class="m">0</span>.994
cloudprober <span class="m">1519</span>..4 <span class="m">1519583412</span> <span class="nv">labels</span><span class="o">=</span><span class="nv">ptype</span><span class="o">=</span>external,probe<span class="o">=</span>redis_probe,dst<span class="o">=</span> <span class="nv">success</span><span class="o">=</span><span class="m">3</span> <span class="nv">total</span><span class="o">=</span><span class="m">3</span> <span class="nv">latency</span><span class="o">=</span><span class="m">42621</span>.871</code></pre></div>

<p>You can import this data in prometheus following the process outlined at:
<a href="https://katee.github.io/cloudprober/getting-started/#running-prometheus">Running Prometheus</a>. Before doing that, let&rsquo;s make it more interesting.</p>

<h2 id="distributions">Distributions</h2>

<p>How nice will it be if we could find distribution of the set and get latency. If tail latency was too high, it could explain the random timeouts in your application. Fortunately, it&rsquo;s very easy to create distributions in Cloudprober. You just need to add the following section to your probe definition:</p>

<p>Full example in <a href="https://github.com/google/cloudprober/blob/master/examples/external/cloudprober_aggregate.cfg">examples/external/cloudprober_aggregate.cfg</a>.</p>

<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="err">#</span> <span class="n">Run</span> <span class="n">an</span> <span class="n">external</span> <span class="n">probe</span> <span class="n">and</span> <span class="n">aggregate</span> <span class="n">metrics</span> <span class="n">in</span> <span class="n">cloudprober.</span><span class="err">
</span><span class="err"></span><span class="o">...</span><span class="err">
</span><span class="err"></span><span class="n">output_metrics_options</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="n">aggregate_in_cloudprober</span><span class="o">:</span> <span class="kc">true</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="err">#</span> <span class="n">Create</span> <span class="n">distributions</span> <span class="n">for</span> <span class="n">get_latency_ms</span> <span class="n">and</span> <span class="n">set_latency_ms.</span><span class="err">
</span><span class="err"></span>  <span class="n">dist_metric</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="n">key</span><span class="o">:</span> <span class="s">&#34;get_latency_ms&#34;</span><span class="err">
</span><span class="err"></span>    <span class="n">value</span><span class="o">:</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="n">explicit_buckets</span><span class="o">:</span> <span class="s">&#34;0.1,0.2,0.4,0.6,0.8,1.0,2.0&#34;</span><span class="err">
</span><span class="err"></span>    <span class="p">}</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span>  <span class="n">dist_metric</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="n">key</span><span class="o">:</span> <span class="s">&#34;set_latency_ms&#34;</span><span class="err">
</span><span class="err"></span>    <span class="n">value</span><span class="o">:</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="n">explicit_buckets</span><span class="o">:</span> <span class="s">&#34;0.1,0.2,0.4,0.6,0.8,1.0,2.0&#34;</span><span class="err">
</span><span class="err"></span>    <span class="p">}</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div>

<p>This configuration adds options to aggregate the metrics in the cloudprober and configures &ldquo;get_latency_ms&rdquo; and &ldquo;set_latency_ms&rdquo; as distribution metrics with explicit buckets. Cloudprober will now build cumulative distributions using
for these metrics. We can import this data in Stackdriver or Prometheus and get the percentiles of the &ldquo;get&rdquo; and &ldquo;set&rdquo; latencies. Following screenshot shows the
grafana dashboard built using these metrics.</p>

<p><a href="https://katee.github.io/cloudprober/diagrams/redis_probe_screenshot.png"><img style="float: center;" width=300px src="https://katee.github.io/cloudprober/diagrams/redis_probe_screenshot.png"></a></p>

<h2 id="server-mode">Server Mode</h2>

<p>The probe that we created above forks out a new <code>redis_probe</code> process for every
probe cycle. This can get expensive if probe frequency is high and the process is big (e.g. a Java binary). Also, what if you want to keep some state across probes, for example, lets say you want to monitor performance over HTTP/2 where you keep using the same TCP connection for multiple HTTP requests. A new process
every time makes keeping state impossible.</p>

<p>External probe&rsquo;s server mode provides a way to run the external probe process in daemon mode. Cloudprober communicates with this process over stdout/stdin (connected with OS pipes), using serialized protobuf messages. Cloudprober comes with a serverutils package that makes it easy to build external probe servers in Go.</p>

<p><img src="https://katee.github.io/cloudprober/diagrams/external_probe_server.svg" alt="External Probe Server" /></p>

<p>Please see the code at
<a href="https://github.com/google/cloudprober/blob/master/examples/external/redis_probe.go">examples/external/redis_probe.go</a> for server mode implementation of the above probe. Here is the corresponding
cloudprober config to run this probe in server mode: <a href="https://github.com/google/cloudprober/blob/master/examples/external/cloudprober_server.cfg">examples/external/cloudprober_server.cfg</a>.</p>

<p>In server mode, if external probe process dies for reason, it&rsquo;s restarted by Cloudprober.</p>


			<aside class="copyright" role="note">
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				
			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/katee.github.io\/cloudprober\/';
      var repo_id  = 'Katee\/cloudprober';
    
    </script>

    <script src="https://katee.github.io/cloudprober/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-79661-8', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    
  </body>
</html>

